# **Sensitivity Computations: Integration by Parts**

## Traditional Monte Carlo Sensitivity **Estimators and Their difficulties**

The calculation of price sensitivities is a central modeling and computational problem for derivative securities. The prices of derivative securities are observable in the market; however, price sensitivities, the important inputs in the hedging of derivative securities, are not. Models and computational tools are thus required to establish such information which the market does not provide directly.

Mathematically, price sensitivities or greeks are partial derivatives of financial derivative prices with respect to some specific parameters of the underlying market variables. For instance, "delta" means the sensitivity to changes in the price of the underlying asset. More formally, suppose that the underlying model dynamic under the risk neutral probability is given by a stochastic differential equation (SDE) on  $[0, T],$ 

$$dX_t = \mu(X_t) dt + \sigma(X_t) dW_t, X_0 = x \qquad (1)$$

where  $W$  is a standard Brownian motion. By the noarbitrage argument, the present value of a derivative should be

$$V(x) = E[\Phi(X_T)|X_0 = x] \tag{2}$$

where  $\Phi$  is the (discounted) payoff function. For notation at simplicity, we restrict attention to scalar  $X$  and such  $\Phi$  that depends only on  $X_T$  in the article. Then, the delta of such a model is defined as  $dV(x)/dx$ .

The simplest and crudest approach to the Monte Carlo estimation of greeks is via finite-difference approximation. In other words, we simulate the derivative prices at two or more values of the underlying parameter and then estimate greeks by taking difference quotients between these values. Finite-difference estimators are easy to implement, but are prone to large bias, large variance, and added computational requirements.

To overcome the shortages of the finite-difference method, traditionally there have been two categories

of methods for estimating sensitivities: methods that differentiate paths and methods that differentiate densities. The former one is known as the *pathwise derivative method* or the infinitesimal perturbation analysis in the literature and the latter is usually referred to as the likelihood ratio method (see **Monte** Carlo Greeks). Both of them yield unbiased estimators. But the former requires smooth conditions on the payoff function  $\Phi$ . It fails to provide any sensible estimators for options with discontinuous payoff functions such as digital options. The estimator produced by the latter involves the transition density function of  $X_T$ , which is unavailable in most circumstances when the dynamics  $(1)$  is not trivial.

#### **Method of Integration by Parts**

Fournié *et al.* [7, 8] developed an approach to bypass both the difficulties the traditional methods encounter. It is based on the *integration-by-parts* formula, which lies at the heart of the theory of the Malliavin calculus. Here, we state several relevant conclusions only and leave readers with interest to find more on the detailed and rigorous treatment of the Malliavin calculus and the related financial applications in Nualart [11] and Malliavin and Thalmaier [10]. For notational simplicity, we use the scalar case only in the article to demonstrate the basic idea of the method and refer readers to the relevant literature for more general and rigorous treatments.

Let  $\{W_t : 0 \le t \le T\}$  be a standard Brownian motion defined on a probability space  $(\Omega, \mathcal{F}, P)$  and let  $\{\mathcal{F}_t : 0 < t < T\}$  be the filtration generated by W. Consider a random variable  $F$  of the form

$$F = f\left(\int_0^T h_u \, \mathrm{d}W_u\right) \tag{3}$$

where  $f$  is a real function with some proper smoothness and  $\{h_u: 0 \le t \le T\}$  is an  $L^2[0, T]$ valued stochastic process on  $(\Omega, \mathcal{F}, P)$ . The Malli*avin derivative* of  $F$  is defined as a stochastic process  $DF = \{D_t F : 0 \le t \le T\}$ , where

$$D_t F = f' \left( \int_0^T h_u \, \mathrm{d} W_u \right) \cdot h_t \tag{4}$$

Notice that  $\int_0^T h_u dW_u$  is defined as the limiting summation  $\sum_{u < T} h_u \cdot dW_u := \sum_{u < T} h_u \cdot (W_{u+du} - W_u)$ .

So, one can view the Malliavin derivative as an ordinary derivative of the random variable  $F$  with respect to  $dW_t$ , the small increment of the Brownian motion over  $[t, t + dt]$ , heuristically.

The Malliavin derivative satisfies the chain rule as the ordinary derivative, that is, for any differentiable real function  $\phi$ ,  $D\phi(F) = \phi'(F) \cdot DF$ . Apply  $D_t$  on  $X_T$  defined by the SDE (1). Recall that

$$X_T = X_t + \int_t^T \mu(X_u) \, \mathrm{d}u + \int_t^T \sigma(X_u) \, \mathrm{d}W_u \quad (5)$$

 $X_t$  depends only on the Brownian increments before t. Thus,  $D_t X_t = 0$ . By the chain rule,  $D_t\left(\int_t^T \mu(X_u) \, \mathrm{d}u\right) = \int_t^T \mu'(X_u) \cdot D_t X_u \, \mathrm{d}u.$  And

$$D_{t} \left( \int_{t}^{T} \sigma(X_{u}) \, \mathrm{d}W_{u} \right)$$
  
$$= D_{t}(\sigma(X_{t}) \, \mathrm{d}W_{t} + \int_{t+\mathrm{d}t}^{T} \sigma(X_{u}) \, \mathrm{d}W_{u})$$
  
$$= \sigma(X_{t}) + \int_{t+\mathrm{d}t}^{T} \sigma'(X_{u}) \cdot D_{t}X_{u} \, \mathrm{d}W_{u} \qquad (6)$$

So we have

$$D_t X_T = \sigma(X_t) + \int_t^T \mu'(X_u) \cdot D_t X_u \, \mathrm{d}u$$
$$+ \int_t^T \sigma'(X_u) \cdot D_t X_u \, \mathrm{d}W_u \qquad (7)$$

On the other hand, if one introduces a new process  $Y$  such that it is the derivative of  $X$  with respect to its initial value, that is,  $Y_t = dX_t/dx$ , then

$$dY_t = \mu'(X_t)Y_t \, dt + \sigma'(X_t)Y_t \, dW_t, \ Y_0 = 1 \quad (8)$$

Comparing equations  $(7)$  and  $(8)$ , we can see the process  $\{D_t X_u : t \le u \le T\}$  should follow the same SDE as  $Y$  but with different initial value at  $t$ . Thus,

$$D_t X_T = \frac{Y_T}{Y_t} \cdot \sigma(X_t) \tag{9}$$

One of the most important properties of the Malliavin derivative is the following duality property: given a process  $h = \{h_t : 0 \le t \le T\}$ , there exists a random variable  $D^*(h)$  such that

$$E\left[\int_0^T D_t \Phi(X_T) \cdot h_t \, \mathrm{d}t\right] = E[\Phi(X_T) \cdot D^*(h)] \tag{10}$$

for all functions  $\Phi$  with some proper smoothness conditions. Viewing  $D^*$  as a "derivative" in the weak sense—recall that the weak derivative in the PDE theory is defined in this way—one can see that equation  $(10)$  is exactly an analog to the integrationby-parts formula in the ordinary calculus. In the literature,  $D^*$  is called the Skorohod integral. It is easy to show that  $D^*(h)$  should be equal to the Ito integral  $\int_0^T h_u dW_u$  if h is adapted to the filtration  $\mathcal{F}_t$ .

Equation  $(10)$  is the cornerstone for the development of unbiased greeks estimators. Turn back to the derivation of unbiased estimators for the delta. Consider a smooth payoff function  $\Phi$  first. Choose  $h_t \equiv$  $\frac{1}{T}(Y_t/\sigma(X_t))$ , which is adapted, in equation (10). By the chain rule of  $D$ , the left-hand side of equation  $(10)$  is

$$E\left[\int_{0}^{T} D_{t} \Phi(X_{T}) \cdot h_{t} \, \mathrm{d}t\right]$$
  
$$= E\left[\int_{0}^{T} \Phi'(X_{T}) \cdot D_{t} X_{T} \cdot \frac{1}{T} \frac{Y_{t}}{\sigma(X_{t})} \, \mathrm{d}t\right]$$
  
$$= E[\Phi'(X_{T}) \cdot Y_{T}] \tag{11}$$

where the last step uses equation  $(9)$ . The right hand side of equation  $(10)$  equals

$$E\left[\Phi(X_T) \cdot \frac{1}{T} \int_0^T \frac{Y_t}{\sigma(X_t)} \, \mathrm{d}W_t\right] \tag{12}$$

So,

$$E[\Phi'(X_T) \cdot Y_T] = E\left[\Phi(X_T) \cdot \frac{1}{T} \int_0^T \frac{Y_t}{\sigma(X_t)} \, \mathrm{d}W_t\right] \tag{13}$$

Using the pathwise derivative method, we can easily derive that  $\Phi'(X_T) \cdot Y_T$  is an unbiased estimator of the delta. Therefore we have another unbiased estimator

$$\frac{\mathrm{d}V}{\mathrm{d}x} = E\left[\Phi(X_T) \cdot \frac{1}{T} \int_0^T \frac{Y_t}{\sigma(X_t)} \,\mathrm{d}W_t\right] \quad (14)$$

For any nonsmooth  $\Phi$  such that  $E[(\Phi(X_T))^2] <$  $+\infty$ , we can always find a sequence of differentiable  $\Phi^{(n)}$  convergent to it in  $L^2$ , that is,  $E[\|\Phi^{(n)}(X_T) \Phi(X_T)$  $||^2|X_0 = x] \to 0$  as  $n \to +\infty$  for all x. Let  $V^{(n)}(x) = E[\Phi^{(n)}(X_T)|X_0 = x].$  Following the above arguments,

$$\frac{\mathrm{d}V^{(n)}}{\mathrm{d}x} = E\left[\Phi^{(n)}(X_T) \cdot \frac{1}{T} \int_0^T \frac{Y_t}{\sigma(X_t)} \,\mathrm{d}W_t\right] \tag{15}$$

Using the Cauchy–Schwartz inequality, we can easily show that the right-hand side of equation (15) converges to  $E\left[\Phi(X_T) \cdot \frac{1}{T} \int_0^T \frac{Y_t}{\sigma(X_t)} dW_t\right]$ . Thus, equation (14) should hold for such  $\Phi$  too. The advantage of such an estimator is that it does not involve the density functions of  $X_T$  nor does it require  $\Phi$  to be smooth.

#### **Implementation and Some Extensions**

To implement equation (14), we discretize  $[0, T]$ into grids:  $0 = t_0 < t_1 < \cdots < t_N = T$ , where  $t_i =$  $iT/N$ . Simulate the underlying process X and the derivative process  $Y$  simultaneously by

$$\hat{X}_{t_i} = \hat{X}_{t_{i-1}} + \mu(\hat{X}_{t_{i-1}})\Delta t + \sigma(\hat{X}_{t_{i-1}})\Delta W_i,\n$$

$$\n\hat{X}_0 = x\n$$
(16)

$$\hat{Y}_{t_i} = \hat{Y}_{t_{i-1}} + \mu'(\hat{X}_{t_{i-1}})\hat{Y}_{t_{i-1}}\Delta t + \sigma'(\hat{X}_{t_{i-1}})\hat{Y}_{t_{i-1}}\Delta W_i,\n$$

$$\n\hat{Y}_0 = 1\n$$
(17)

and  $\Delta W_i = W_{t_i} - W_{t_{i-1}} \sim$ where  $\Delta t = T/N$  $N(0, \Delta t)$ . Then, approximately we have a delta estimator

$$\Phi(\hat{X}_T) \cdot \frac{1}{T} \sum_{i=1}^{N} \frac{\hat{Y}_{t_{i-1}}}{\sigma(\hat{X}_{t_{i-1}})} \Delta W_i \tag{18}$$

All the above derivations can be generalized to the cases in which  $X$  and  $W$  are both vectors, which has been shown by Fournié *et al.* [7]. They also established unbiased estimators for other greeks for European style options contingent on multidimensional underlying assets, such as the vega, the price sensitivity with respect to the underlying volatility; the rho, the sensitivity with respect to the riskless interest rate; the gamma, the second-order sensitivity with respect

to the underlying price. One crucial assumption they needed is that the underlying model is elliptic, that is,  $\sigma(x)$  is a symmetric positive definite matrix function.

It is worth mentioning that the integration-by-parts method is still applicable for the market where the ellipticity assumption does not hold. For instance, the interest rate market has a high-dimensional state space constituted by the values of bonds at a large number of distinct maturities and a lowdimensionality variance driven by a few noise sources (Brownian motions). Under this setting,  $\sigma(x)$  cannot be positive definite because it has more rows than columns. Malliavin and Thalmaier [10] provide the details on how to develop the corresponding unbiased estimators.

A lot of research has already been done so far in the literature to extend the seminal work of Fournié et al. [7]. Among others, Davis and Johansson [5], El-Khatib and Privault [6], and Bally et al. [1] considered greeks in a market driven by jump-diffusion processes; Gobet and Kohatsu-Higa [9], Bernis et al. [3] derived greek estimators for lookback and barrier options; Bally *et al.* [2] applied the Malliavin calculus method to pricing and hedging American options.

As shown here, Malliavin estimators have been derived directly for diffusion processes, but implementation typically requires simulation of a discretetime approximation. This raises the question of whether one should discretize first and then differentiate, or differentiate first and then discretize. Chen and Glasserman [4] illustrated that both approaches will lead to the same estimators in several important cases, but the first approach uses only elementary techniques such as likelihood ratio and pathwise derivative methods.

#### Acknowledgments

The author thanks Arturo Kohatsu-Higa, Eckhard Platen, Peter Jaeckel, and David Yao for their suggestions and comments in the preparation of this article.

#### References

[1] Bally, V., Bavouzet, M.-P. & Messaoud, M. (2007). Integration by parts formula for locally smooth laws and applications to sensitivity computations, Annals of Applied Probability 17, 33-66.

## **4 Sensitivity Computations: Integration by Parts**

- [2] Bally, V., Caramellino, L. & Zanette, A. (2005). Pricing and hedging American options by Monte Carlo methods using a Malliavin calculus approach, *Monte Carlo Methods and Applications* **11**, 97–133.
- [3] Bernis, G., Gobet, E. & Kohatsu-Higa, A. (2003). Monte Carlo evaluation of greeks for multidimensional barrier and lookback options, *Mathematical Finance* **13**, 99–113.
- [4] Chen, N. & Glasserman, P. (2007). Malliavin greeks without Malliavin calculus, *Stochastic Processes and their Applications* **117**, 1689–1723.
- [5] Davis, M.H.A. & Johansson, M.P. (2006). Malliavin Monte Carlo greeks for jump diffusions, *Stochastic Processes and their Applications* **116**, 101–129.
- [6] El-Khatib, Y. & Privault, N. (2004). Computations of greeks in a market with jumps via the Malliavin calculus, *Finance and Stochastics* **8**, 161–179.
- [7] Fournie, E., Lasry, J.-M., Lebuchoux, J., Lions, P.-L. & ´ Touzi, N. (1999). Applications of Malliavin calculus to Monte Carlo methods in finance, *Finance and Stochastics* **3**, 391–412.

- [8] Fournie, E., Lasry, J.-M., Lebuchoux, J., Lions, P.-L. & ´ Touzi, N. (2001). Applications of Malliavin calculus to Monte Carlo methods in finance. II, *Finance and Stochastics* **5**, 201–236.
- [9] Gobet, E. & Kohatsu-Higa, A. (2003). Computation of greeks for barrier and look-back options using Malliavin Calculus, *Electronic Communications in Probability* **8**, 51–62.
- [10] Malliavin, P. & Thalmaier, A. (2006). *Stochastic calculus of Variations in Mathematical Finance*, Springer.
- [11] Nualart, D. (2006). *The Malliavin Calculus and Related Topics*, 2nd Edition, Springer.

## **Related Articles**

**Monte Carlo Greeks**; **Stochastic Differential Equations: Scenario Simulation**.

NAN CHEN